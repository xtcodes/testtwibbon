<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twibbon Sederhana - Upload & Preview (Perbaikan Drop Area)</title>
  <style>
    :root{--max-width:760px;--gap:12px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:24px;display:flex;justify-content:center}
    .card{width:100%;max-width:var(--max-width);box-shadow:0 6px 18px rgba(0,0,0,0.08);border-radius:12px;padding:18px;position:relative}
    h1{font-size:18px;margin:0 0 8px}
    /* Upload area now a div (not label) so it won't trap focus or cover input */
    .upload-area{border:2px dashed #d0d6df;border-radius:8px;padding:28px;text-align:center;cursor:pointer;transition:background .12s;z-index:20}
    .upload-area.hover{background:#f1f7ff}
    .upload-area input{display:none}
    .small{font-size:13px;color:#6b7280}
    .controls{display:flex;gap:var(--gap);margin-top:12px}
    .controls > *{flex:1}
    button{padding:10px;border-radius:8px;border:0;background:#0ea5a4;color:white;font-weight:600;cursor:pointer}
    button.secondary{background:#64748b}
    .hidden{display:none}
    .preview-wrap{margin-top:16px;display:grid;grid-template-columns:1fr 300px;gap:12px}
    @media (max-width:820px){.preview-wrap{grid-template-columns:1fr}}
    .preview-canvas{background:#10131a;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:12px}
    canvas{width:100%;height:auto;border-radius:6px}
    .meta{background:#fbfdff;border-radius:8px;padding:12px}
    .twibbon-frame{position:relative;display:inline-block}
    /* Frame overlay must not capture pointer events */
    .frame-overlay{position:absolute;inset:0;pointer-events:none;border-radius:6px;z-index:5}
    .frame-overlay .border{position:absolute;inset:0;border:14px solid rgba(255,255,255,0.18);box-sizing:border-box;border-radius:6px}
    .frame-overlay .ribbon{position:absolute;right:0;top:0;padding:6px 14px;background:linear-gradient(90deg,#ef4444,#f97316);color:white;font-weight:700;border-bottom-left-radius:8px}
    .note{margin-top:10px;font-size:13px;color:#334155}
  </style>
</head>
<body>
  <div class="card">
    <h1>Twibbon - Upload & Preview (Perbaikan)</h1>
    <p class="small">Alur: upload gambar → isi nama twibbon → lihat preview & keterangan.</p>

    <!-- STEP 1: Upload area (div, bukan label) -->
    <div class="upload-area" id="uploadArea" tabindex="0">
      <input id="fileInput" type="file" accept="image/*" />
      <div>
        <strong id="uploadText">Klik atau seret gambar ke sini</strong>
        <div class="small">PNG/JPG, maksimal 10MB</div>
      </div>
    </div>

    <!-- STEP 2: Nama twibbon (muncul setelah upload) -->
    <div id="nameSection" class="hidden" style="margin-top:12px">
      <input id="twibbonName" placeholder="Masukkan nama twibbon (contoh: Dukungan Acara X)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6" />
      <div style="display:flex;gap:10px;margin-top:8px">
        <button id="applyName">Terapkan & Lihat Preview</button>
        <button id="resetBtn" class="secondary">Reset</button>
      </div>
    </div>

    <!-- PREVIEW + METADATA -->
    <div id="previewSection" class="hidden preview-wrap">
      <div>
        <div class="preview-canvas">
          <div class="twibbon-frame" style="width:100%;max-width:640px">
            <canvas id="previewCanvas" width="800" height="800"></canvas>
            <div class="frame-overlay" id="frameOverlay">
              <div class="border"></div>
              <div class="ribbon">TWIBBON</div>
            </div>
          </div>
        </div>
        <div class="note">Tip: gunakan gambar dengan subjek di tengah untuk hasil terbaik.</div>
      </div>
      <div class="meta">
        <p><strong>Nama Twibbon:</strong> <span id="metaName">-</span></p>
        <p><strong>Waktu Upload:</strong> <span id="metaTime">-</span></p>
        <p><strong>Total Dukungan:</strong> <span id="metaCount">-</span></p>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="downloadBtn">Unduh Hasil</button>
          <button id="supportBtn" class="secondary">Dukung (+1)</button>
        </div>
      </div>
    </div>

    <p class="small" style="margin-top:14px">Versi sederhana — tidak mengubah layout utama. Kode di bawah mudah dihubungkan ke Supabase (lihat komentar dalam JS).</p>
  </div>

  <script>
    // --- Konfigurasi ---
    const useSupabase = false; // masih default false

    // --- Elemen DOM ---
    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const uploadText = document.getElementById('uploadText');
    const nameSection = document.getElementById('nameSection');
    const twibbonNameInput = document.getElementById('twibbonName');
    const applyNameBtn = document.getElementById('applyName');
    const resetBtn = document.getElementById('resetBtn');
    const previewSection = document.getElementById('previewSection');
    const previewCanvas = document.getElementById('previewCanvas');
    const metaName = document.getElementById('metaName');
    const metaTime = document.getElementById('metaTime');
    const metaCount = document.getElementById('metaCount');
    const downloadBtn = document.getElementById('downloadBtn');
    const supportBtn = document.getElementById('supportBtn');

    const ctx = previewCanvas.getContext('2d');
    let loadedImage = null;
    let currentCount = 0; // total dukungan

    // --- Helper: format waktu lokal (WIB 24h) ---
    function formatTime(date){
      return new Intl.DateTimeFormat('id-ID', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).format(date);
    }

    // --- localStorage fallback ---
    const SUPPORT_KEY = 'twibbon_total_support_v1';
    function loadLocalCount(){
      const v = localStorage.getItem(SUPPORT_KEY);
      currentCount = v ? parseInt(v,10) : 0;
      updateCountUI();
    }
    function saveLocalCount(){ localStorage.setItem(SUPPORT_KEY, String(currentCount)); }
    function incrementLocalCount(){ currentCount++; saveLocalCount(); updateCountUI(); }
    function updateCountUI(){ metaCount.textContent = currentCount; }

    // --- Drag & drop (robust) ---
    uploadArea.addEventListener('dragover', (e)=>{ e.preventDefault(); uploadArea.classList.add('hover'); });
    uploadArea.addEventListener('dragleave', ()=>{ uploadArea.classList.remove('hover'); });
    uploadArea.addEventListener('drop', (e)=>{ e.preventDefault(); uploadArea.classList.remove('hover'); const f = e.dataTransfer.files[0]; handleFile(f); });

    // Make uploadArea focusable & trigger file input via single click or Enter/Space
    uploadArea.addEventListener('click', ()=> fileInput.click());
    uploadArea.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); fileInput.click(); } });

    // Ensure fileInput change triggers handleFile once
    fileInput.addEventListener('change', (e)=>{ if(e.target.files && e.target.files[0]) handleFile(e.target.files[0]); });

    function handleFile(file){
      if(!file) return;
      if(!file.type.startsWith('image/')){ alert('Pilih file gambar.'); return; }

      const reader = new FileReader();
      reader.onload = (ev)=>{
        const img = new Image();
        img.onload = ()=>{
          loadedImage = img;
          // HIDE upload area so it can't be 'tertutup' lagi
          uploadArea.classList.add('hidden');
          // show name input
          nameSection.classList.remove('hidden');
          // auto-fill default name
          twibbonNameInput.value = 'Twibbon - ' + (file.name.split('.')[0] || 'gambar');
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);

      // clear input value so same file can be reselected if user resets
      fileInput.value = '';
    }

    // --- Apply name & render preview ---
    applyNameBtn.addEventListener('click', ()=>{
      if(!loadedImage) return alert('Unggah gambar dulu.');
      const name = twibbonNameInput.value.trim() || 'Tanpa Nama';
      metaName.textContent = name;
      const now = new Date();
      metaTime.textContent = formatTime(now);
      previewSection.classList.remove('hidden');
      nameSection.classList.add('hidden');

      // draw image into canvas, center-cover
      drawImageCover(ctx, loadedImage, previewCanvas.width, previewCanvas.height);

      // draw overlay with name
      drawTwibbonOverlay(ctx, previewCanvas.width, previewCanvas.height, name);

      if(useSupabase){
        // TODO: implement fetch from Supabase
        updateCountUI();
      } else {
        loadLocalCount();
      }
    });

    resetBtn.addEventListener('click', ()=>{
      loadedImage = null; previewSection.classList.add('hidden'); nameSection.classList.add('hidden');
      uploadArea.classList.remove('hidden');
      twibbonNameInput.value = '';
      fileInput.value = '';
    });

    supportBtn.addEventListener('click', ()=>{
      if(useSupabase){
        alert('Supabase belum diaktifkan pada contoh ini.');
      } else {
        incrementLocalCount();
      }
    });

    downloadBtn.addEventListener('click', ()=>{
      const dataUrl = previewCanvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl;
      const host = (window.location && window.location.host) ? window.location.host.replace(/[:.]/g,'-') : 'twibbon';
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      a.download = `${host}_${dd}-${mm}-${yyyy}.png`;
      a.click();
    });

    // --- Drawing helpers ---
    function drawImageCover(ctx, img, w, h){
      const iw = img.width, ih = img.height;
      const scale = Math.max(w/iw, h/ih);
      const nw = iw * scale, nh = ih * scale;
      const dx = (w - nw)/2, dy = (h - nh)/2;
      ctx.clearRect(0,0,w,h);
      ctx.drawImage(img, dx, dy, nw, nh);
    }

    function drawTwibbonOverlay(ctx, w, h, name){
      ctx.fillStyle = 'rgba(0,0,0,0.12)';
      ctx.fillRect(0,0,w,h);
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 12; ctx.strokeRect(6,6,w-12,h-12);
      const ribbonW = Math.floor(w*0.28), ribbonH = 48;
      ctx.save();
      ctx.translate(w,0);
      ctx.beginPath();
      ctx.moveTo(-ribbonW,0);
      ctx.lineTo(0,0);
      ctx.lineTo(0,ribbonH);
      ctx.lineTo(-ribbonW+18,ribbonH);
      ctx.closePath();
      const g = ctx.createLinearGradient(w-ribbonW,0,w,0);
      g.addColorStop(0,'#ef4444'); g.addColorStop(1,'#f97316');
      ctx.fillStyle = g; ctx.fill();
      ctx.fillStyle = '#fff'; ctx.font = '700 18px sans-serif'; ctx.textBaseline = 'middle';
      ctx.fillText(name.length>18?name.slice(0,15)+'...':name, -ribbonW+12, ribbonH/2);
      ctx.restore();
    }

    // --- Init ---
    (function init(){
      const size = 800;
      previewCanvas.width = size; previewCanvas.height = size;
      nameSection.classList.add('hidden'); previewSection.classList.add('hidden');
      loadLocalCount();
    })();
  </script>
</body>
</html>
