<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twibbon Hub - Buat, Galeri, & Pakai (Satu Halaman)</title>
  <style>
    :root{--max-width:980px}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;display:flex;justify-content:center}
    .app{width:100%;max-width:var(--max-width)}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    nav{display:flex;gap:8px}
    button.tab{padding:8px 12px;border-radius:8px;border:0;background:#e6eef6;cursor:pointer}
    button.tab.active{background:#0ea5a4;color:white}
    .card{background:white;border-radius:12px;padding:16px;margin-top:12px;box-shadow:0 6px 20px rgba(2,6,23,0.06)}

    /* layout */
    .columns{display:grid;grid-template-columns:1fr 360px;gap:12px}
    @media (max-width:880px){.columns{grid-template-columns:1fr}}

    .upload-area{border:2px dashed #d0d6df;border-radius:8px;padding:20px;text-align:center;cursor:pointer}
    .upload-area.hover{background:#f1f7ff}
    input[type=file]{display:none}
    .small{font-size:13px;color:#6b7280}
    .controls{display:flex;gap:8px;margin-top:12px}
    .controls button{flex:1;padding:10px;border-radius:8px;border:0;background:#0ea5a4;color:white;font-weight:600}
    .secondary{background:#64748b}

    .gallery-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    @media (max-width:520px){.gallery-grid{grid-template-columns:repeat(1,1fr)}}
    .tile{border-radius:10px;overflow:hidden;background:#f8fafc;position:relative;padding:8px}
    .tile img{width:100%;height:140px;object-fit:cover;display:block}
    .tile .meta{padding:8px;font-size:13px}
    .tile .meta strong{display:block}

    .editor-canvas{background:#0b1220;border-radius:8px;padding:12px;display:flex;align-items:center;justify-content:center}
    canvas{width:100%;height:auto;border-radius:6px;max-width:100%}

    .note{font-size:13px;color:#334155;margin-top:8px}
    .muted{color:#64748b;font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Twibbon Hub — Buat, Galeri, & Pakai</h1>
      <nav>
        <button class="tab active" data-view="create">Buat Twibbon</button>
        <button class="tab" data-view="gallery">Galeri Twibbon</button>
        <button class="tab" data-view="use">Pakai Twibbon</button>
      </nav>
    </header>

    <div class="card" id="view-create">
      <h2>Buat Twibbon</h2>
      <p class="small">Unggah file twibbon (frame) — sebaiknya PNG dengan background transparan. Setelah disimpan, twibbon akan muncul di galeri dan bisa dipakai orang lain.</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <div id="frameDrop" class="upload-area" tabindex="0">
            <input id="frameFile" type="file" accept="image/*" />
            <div>
              <strong id="frameDropText">Klik atau seret frame (PNG/JPG)</strong>
              <div class="small">Rekomendasi: PNG 2000×2000 dengan area transparan.</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <input id="frameName" placeholder="Nama Twibbon (contoh: Hari Guru 2025)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6" />
            <div class="controls">
              <button id="saveFrame">Simpan ke Galeri</button>
              <button id="clearFrame" class="secondary">Batal</button>
            </div>
            <div class="note">Jika kamu punya Supabase, nyalakan integrasi di baris konfigurasi di bawah (dijelaskan di komentar).</div>
          </div>
        </div>
        <div style="width:360px">
          <div class="editor-canvas">
            <canvas id="previewFrameCanvas" width="600" height="600"></canvas>
          </div>
          <div class="muted">Preview: tampilan frame sebelum disimpan ke galeri.</div>
        </div>
      </div>
    </div>

    <div class="card hidden" id="view-gallery">
      <h2>Galeri Twibbon</h2>
      <p class="small">Daftar twibbon yang tersimpan di situs ini (di browser ini). Klik "Pakai" untuk memakai twibbon tersebut pada foto Anda.</p>
      <div id="galleryGrid" class="gallery-grid"></div>
      <div class="note">Catatan: saat Supabase belum aktif, galeri hanya tersimpan di browser kamu. Aktifkan Supabase agar twibbon dapat diakses semua orang.</div>
    </div>

    <div class="card hidden" id="view-use">
      <h2>Pakai Twibbon</h2>
      <p class="small">Pilih twibbon dari galeri (atau unggah frame langsung), lalu unggah foto Anda untuk menerapkan twibbon.</p>
      <div class="columns">
        <div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="selectTwibbon" style="flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef6">
              <option value="">-- Pilih Twibbon dari Galeri --</option>
            </select>
            <button id="refreshGallery" class="secondary" style="margin-left:8px;padding:8px 10px">Refresh</button>
          </div>

          <div style="margin-top:10px" class="upload-area" id="photoDrop" tabindex="0">
            <input id="photoFile" type="file" accept="image/*" />
            <div>
              <strong id="photoDropText">Klik atau seret foto Anda di sini</strong>
              <div class="small">JPG/PNG, ideal 800×800 atau lebih besar.</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="applyTwibbon">Terapkan Twibbon</button>
            <button id="downloadResult" class="secondary">Unduh Hasil</button>
          </div>

          <div class="note">Setelah klik "Terapkan", preview muncul di kanan. Tombol unduh hanya untuk hasil akhir — twibbon aslinya tetap tersimpan di galeri.</div>
        </div>

        <div>
          <div class="editor-canvas">
            <canvas id="resultCanvas" width="800" height="800"></canvas>
          </div>
          <div class="muted" style="margin-top:6px">Preview hasil — gunakan tombol unduh untuk menyimpan gambar komposit ke perangkatmu.</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ========== Konfigurasi Supabase (opsional) ==========
    // Jika kamu mau supaya galeri tersimpan di server sehingga semua user bisa mengaksesnya,
    // isi SUPABASE_URL dan SUPABASE_ANON_KEY, lalu set useSupabase = true.
    // Saya sudah menulis bagian integrasinya sebagai TODO — tinggal masukkan kredensial.
    const useSupabase = false; // ubah ke true jika sudah konfigurasi
    const SUPABASE_URL = '';
    const SUPABASE_ANON_KEY = '';

    // ====================================================

    // Elemen
    const tabs = document.querySelectorAll('button.tab');
    const views = {create: document.getElementById('view-create'), gallery: document.getElementById('view-gallery'), use: document.getElementById('view-use')};

    tabs.forEach(t => t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const view = t.dataset.view;
      Object.values(views).forEach(v=>v.classList.add('hidden'));
      views[view].classList.remove('hidden');
      if(view === 'gallery') renderGallery();
      if(view === 'use') populateSelect();
    }));

    // Storage fallback: localStorage (key)
    const STORAGE_KEY = 'twibbon_hub_v1';

    function loadTwibbons(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){ return []; }
    }
    function saveTwibbons(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    // Utility: generate id
    function uid(){ return 't'+Date.now()+'-'+Math.random().toString(36).slice(2,8); }

    // ----------- Create Twibbon logic -----------
    const frameDrop = document.getElementById('frameDrop');
    const frameFile = document.getElementById('frameFile');
    const frameName = document.getElementById('frameName');
    const previewFrameCanvas = document.getElementById('previewFrameCanvas');
    const ctxFrame = previewFrameCanvas.getContext('2d');
    let currentFrameData = null; // dataURL

    // drag/drop handlers
    ;['dragover','dragenter'].forEach(ev => frameDrop.addEventListener(ev, e=>{ e.preventDefault(); frameDrop.classList.add('hover'); }));
    frameDrop.addEventListener('dragleave', e=>{ frameDrop.classList.remove('hover'); });
    frameDrop.addEventListener('drop', e=>{ e.preventDefault(); frameDrop.classList.remove('hover'); const f = e.dataTransfer.files[0]; handleFrameFile(f); });
    frameDrop.addEventListener('click', ()=> frameFile.click());
    frameFile.addEventListener('change', e=>{ if(e.target.files && e.target.files[0]) handleFrameFile(e.target.files[0]); frameFile.value = ''; });

    function handleFrameFile(file){
      if(!file) return;
      if(!file.type.startsWith('image/')) return alert('Pilih file gambar.');
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = ()=>{
          currentFrameData = ev.target.result;
          // draw fit into preview canvas
          const cw = previewFrameCanvas.width, ch = previewFrameCanvas.height;
          ctxFrame.clearRect(0,0,cw,ch); ctxFrame.drawImage(img,0,0,cw,ch);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }

    document.getElementById('saveFrame').addEventListener('click', ()=>{
      const name = frameName.value.trim();
      if(!currentFrameData) return alert('Unggah frame terlebih dahulu.');
      if(!name) return alert('Isi nama twibbon.');
      const list = loadTwibbons();
      const item = { id: uid(), name, data: currentFrameData, created_at: new Date().toISOString() };
      list.unshift(item);
      saveTwibbons(list);
      frameName.value = '';
      currentFrameData = null; ctxFrame.clearRect(0,0,previewFrameCanvas.width,previewFrameCanvas.height);
      alert('Twibbon tersimpan ke galeri (lokal). Jika ingin agar semua orang dapat mengakses, aktifkan Supabase di konfigurasi.');
      renderGallery();
    });
    document.getElementById('clearFrame').addEventListener('click', ()=>{ currentFrameData=null; ctxFrame.clearRect(0,0,previewFrameCanvas.width,previewFrameCanvas.height); frameName.value=''; });

    // ----------- Gallery rendering -----------
    const galleryGrid = document.getElementById('galleryGrid');
    function renderGallery(){
      const list = loadTwibbons();
      galleryGrid.innerHTML = '';
      if(list.length===0){ galleryGrid.innerHTML = '<div class="muted">Belum ada twibbon. Buat terlebih dahulu di tab "Buat Twibbon".</div>'; return; }
      list.forEach(it => {
        const tile = document.createElement('div'); tile.className='tile';
        const img = document.createElement('img'); img.src = it.data; img.alt = it.name;
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<strong>${escapeHtml(it.name)}</strong><div class="muted">${new Date(it.created_at).toLocaleString()}</div>`;
        const btns = document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px'; btns.style.marginTop='6px';
        const useBtn = document.createElement('button'); useBtn.textContent='Pakai'; useBtn.style.flex='1'; useBtn.addEventListener('click', ()=>{ goToUseModeWith(it.id); });
        const delBtn = document.createElement('button'); delBtn.textContent='Hapus'; delBtn.className='secondary'; delBtn.style.flex='1'; delBtn.addEventListener('click', ()=>{ if(confirm('Hapus twibbon ini dari galeri?')){ deleteTwibbon(it.id); } });
        btns.appendChild(useBtn); btns.appendChild(delBtn);
        tile.appendChild(img); tile.appendChild(meta); tile.appendChild(btns);
        galleryGrid.appendChild(tile);
      });
    }

    function deleteTwibbon(id){ const list = loadTwibbons().filter(x=>x.id!==id); saveTwibbons(list); renderGallery(); populateSelect(); }

    function goToUseModeWith(id){ // switch to use tab and select
      document.querySelector('button.tab[data-view="use"]').click();
      setTimeout(()=>{ const sel = document.getElementById('selectTwibbon'); sel.value = id; }, 80);
    }

    // ----------- Use Twibbon logic -----------
    const selectTwibbon = document.getElementById('selectTwibbon');
    const refreshGalleryBtn = document.getElementById('refreshGallery');
    const photoDrop = document.getElementById('photoDrop');
    const photoFile = document.getElementById('photoFile');
    const resultCanvas = document.getElementById('resultCanvas');
    const ctxResult = resultCanvas.getContext('2d');
    let selectedFrame = null; // object
    let loadedPhoto = null;

    function populateSelect(){
      const list = loadTwibbons();
      selectTwibbon.innerHTML = '<option value="">-- Pilih Twibbon dari Galeri --</option>';
      list.forEach(it => {
        const o = document.createElement('option'); o.value = it.id; o.textContent = it.name; selectTwibbon.appendChild(o);
      });
    }
    refreshGalleryBtn.addEventListener('click', ()=> populateSelect());

    selectTwibbon.addEventListener('change', ()=>{
      const id = selectTwibbon.value;
      const list = loadTwibbons(); selectedFrame = list.find(x=>x.id===id) || null;
      // preview frame on canvas if no photo yet
      drawResultPreview();
    });

    ;['dragover','dragenter'].forEach(ev => photoDrop.addEventListener(ev, e=>{ e.preventDefault(); photoDrop.classList.add('hover'); }));
    photoDrop.addEventListener('dragleave', e=> photoDrop.classList.remove('hover'));
    photoDrop.addEventListener('drop', e=>{ e.preventDefault(); photoDrop.classList.remove('hover'); const f = e.dataTransfer.files[0]; handlePhotoFile(f); });
    photoDrop.addEventListener('click', ()=> photoFile.click());
    photoFile.addEventListener('change', e=>{ if(e.target.files && e.target.files[0]) handlePhotoFile(e.target.files[0]); photoFile.value=''; });

    function handlePhotoFile(file){ if(!file) return; if(!file.type.startsWith('image/')) return alert('Pilih file gambar.'); const reader = new FileReader(); reader.onload = ev=>{ const img = new Image(); img.onload = ()=>{ loadedPhoto = img; drawResultPreview(); }; img.src = ev.target.result; }; reader.readAsDataURL(file); }

    document.getElementById('applyTwibbon').addEventListener('click', ()=>{
      if(!selectedFrame) return alert('Pilih twibbon dulu.');
      if(!loadedPhoto) return alert('Unggah foto Anda dulu.');
      composeResult();
    });

    document.getElementById('downloadResult').addEventListener('click', ()=>{
      const a = document.createElement('a'); a.href = resultCanvas.toDataURL('image/png'); a.download = 'hasil_twibbon.png'; a.click();
    });

    function drawResultPreview(){
      const w = resultCanvas.width, h = resultCanvas.height;
      ctxResult.clearRect(0,0,w,h);
      // if photo exists, draw scaled cover
      if(loadedPhoto){ drawCover(ctxResult, loadedPhoto, w, h); }
      // if frame selected, draw it semi-transparent (frame image may have transparency)
      if(selectedFrame){ const img = new Image(); img.onload = ()=>{ ctxResult.drawImage(img,0,0,w,h); }; img.src = selectedFrame.data; }
    }

    function composeResult(){ // produce final composited image with frame
      drawResultPreview();
      alert('Hasil sudah ditampilkan. Gunakan tombol Unduh Hasil untuk menyimpan ke perangkat.');
    }

    function drawCover(ctx, img, w, h){ const iw = img.width, ih = img.height; const scale = Math.max(w/iw, h/ih); const nw = iw*scale, nh = ih*scale; const dx = (w-nw)/2, dy = (h-nh)/2; ctx.drawImage(img, dx, dy, nw, nh); }

    // ----------- Helpers -----------
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]||c)); }

    // Initialize UI
    (function init(){
      renderGallery(); populateSelect();
      // ensure canvases have sensible drawing size
      previewFrameCanvas.width = 600; previewFrameCanvas.height = 600;
      resultCanvas.width = 800; resultCanvas.height = 800;
    })();

    // ========== Supabase integration notes (for later) ==========
    /*
      Untuk menyimpan ke server agar semua user bisa mengakses:
      1) Buat project Supabase, aktifkan Storage bucket (misal 'twibbons'), dan buat public policy.
      2) Buat tabel 'twibbons' dengan kolom: id (text PK), name (text), path (text), created_at (timestamp), owner (text)
      3) Di config di atas, isi SUPABASE_URL & SUPABASE_ANON_KEY dan set useSupabase = true.
      4) Implementasikan upload: unggah file ke storage (supabase.storage.from('twibbons').upload(path, file)) dan simpan metadata ke tabel.
      5) Ganti loadTwibbons/saveTwibbons untuk menggunakan API Supabase (fetch) dan panggil render.

      Karena sekarang kamu pilih 1 file HTML sederhana, saya sediakan fallback localStorage supaya fungsi dasar langsung jalan. Kalau mau, nanti saya tambahkan versi lengkap integrasi Supabase (akan butuh credentials dan sedikit server rules).
    */

  </script>
</body>
</html>
