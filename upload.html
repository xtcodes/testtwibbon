<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Result</title>
<style>
body, html {
  margin:0; padding:0; height:100%; width:100%;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  font-family:Arial, sans-serif; background:#fff;
}
#canvas { max-width:90vw; max-height:90vw; opacity:0; transition:opacity 0.5s; }
#downloadBtn { margin-top:20px; padding:10px 20px; font-size:1rem; cursor:pointer; }
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<button id="downloadBtn">Download PFP</button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const downloadBtn = document.getElementById('downloadBtn');
const userImage = localStorage.getItem('userImage');
const twibbonURL = 'https://i.ibb.co/7v3h1tW/twibbon.png';

if(!userImage){ window.location.href='../index.html'; }

const img = new Image();
const twibbon = new Image();
let loaded = 0;
img.onload = checkLoad; twibbon.onload = checkLoad;
img.src = userImage; twibbon.src = twibbonURL;

function checkLoad(){
  loaded++;
  if(loaded < 2) return;

  // Hitung square crop (ambil sisi terkecil)
  const side = Math.min(img.width, img.height);
  const sx = (img.width - side)/2;
  const sy = (img.height - side)/2;

  canvas.width = side;
  canvas.height = side;

  // Draw user photo (square crop)
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, sx, sy, side, side, 0, 0, canvas.width, canvas.height);

  // Draw twibbon overlay
  ctx.drawImage(twibbon, 0, 0, canvas.width, canvas.height);

  // Fade-in canvas
  canvas.style.opacity = 1;
}

// Download
downloadBtn.addEventListener('click',()=>{
  const link = document.createElement('a');
  link.href = canvas.toDataURL('image/png');
  link.download = 'twibbon_pfp.png';
  link.click();
});
</script>

</body>
</html>
